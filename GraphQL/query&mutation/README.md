## query & mutation

GraphQL에서 특정 필드를 요청하는 것은 매우 간단하다.

![https://tech.kakao.com/files/graphql-example.png](https://tech.kakao.com/files/graphql-example.png)

쿼리와 결과가 거의 동일한 형태이다.

gql에서는 쿼리와 뮤테이션을 나누어서 사용하는데 사실 이 두개는 별 차이가 없다.

쿼리는 데이터를 읽어오는데 사용하고 뮤테이션은 데이터를 입력, 수정, 삭제할 때 사용한다는 규약만이 존재한다.

위에서는 query 키워드와 query 이름을 생략한 단축문을 사용했다. 하지만 실제 애플리케이션에서는 헷갈리지 않게 작업타임, 작업이름을 정해주는 것이 좋다.

<img width="728" alt="image" src="https://user-images.githubusercontent.com/98325285/202834340-f16b76bf-0d80-4b3e-a6d2-6b3c9e1188bd.png">

작업 타입은 쿼리(query), 뮤테이션(mutation), 구독(subscription)이 될 수 있고, 어떤 작업의 타입인지를 기술한다.

작업 이름은 의미있고 명시적으로 지어주는 것이 좋다. 디버깅이나 서버 측에서 로깅하는데 훨씬 유용하기 때문이다. 만약 네트워크 로그나 GraphQL 서버에 문제가 발생했을 경우 내용을 확인하는 대신 코드에서 쿼리의 작업이름을 찾아내는 것이 더욱 쉽다.

## 프래그먼트

예를 들어 친구를 가진 두 영웅을 순서대로 요청한다고 가정해보자. 그러면 필드를 최소 두번 반복해야 하기 때문에 쿼리가 복잡해질 수 있다.

이것이 **프래그먼트**라는 재사용 가능한 단위가 GrahpQL에 포함된 이유이다. 프래그먼트를 사용하면 필드셋을 구성한 다음 필요한 쿼리에 포함시킬 수 있다.

<img width="688" alt="image" src="https://user-images.githubusercontent.com/98325285/202901014-41ffd4fb-16a9-4396-b15c-7d5611d40d84.png">

필드가 반복될 경우 위 쿼리가 꽤 반복될 것을 알 수 있다. 프래크먼트 개념은 복잡한 응용프로그램의 데이터 요구사항을 작은 단위로 분할하는데 사용된다. 특히 청크가 다른 여러 UI구성 요소를 하나의 초기 데이터 fetch로 통합해야 하는 경우에 많이 사용된다.

## 변수

지금까지는 모든 인자를 쿼리 문자열 안에서 작성했다. 하지만 대부분 응용프로그램에서 필드에 대한 인자(parameter)는 동적이다. 예를 들어, 어떤 스타워즈 에피소드에 관심이 있는지를 선택할 수 있는 드롭다운, 검색필드, 필터 등이 있을 수도 있다.

지금까지 해왔던 문자열 안에 인자를 작성하는 방법은 좋은 방법이 아니다. 대신 GraphQL은 동적 값을 쿼리 안에서 없애고, 이를 별도로 전달하는 방법을 제공한다. 이것을 변수라고 한다.

변수를 사용하기 위해서는 다음과 같은 작업을 해야한다.

1. 쿼리 안의 정적 값을 `$variableName`으로 변경한다.
2. `$variableName`을 쿼리에서 받는 변수로 선언한다.
3. 별도의 전송규약(일반적으로는 JSON) 변수에 `variableName: value`를 전달한다.

<img width="730" alt="image" src="https://user-images.githubusercontent.com/98325285/203086163-9300941d-fdc6-43e2-9af4-cf7a83f9ba04.png">

위와 같은 방법을 사용하여 코드에서 새로운 쿼리를 작성하지 않고 간단하게 다른 변수를 전달할 수 있다. 이 방법은 일반적으로 쿼리가 어떤 인자가 동적인지를 나타내는 좋은 방법이다.

### 변수 정의

변수 정의는 위 쿼리에서 `($episode: Episode)` 부분이다. 정적타입의 언어의 함수에 대한 인자(parmeter) 정의와 동일하다. $접두사가 붙은 모든 변수를 나열하고 그 뒤에 타입(이 경우 `Episode`)이 온다.

선언된 모든 변수는 `스칼라(단 하나의 값만 저장할 수 있는 데이터 타입), 열거형, input object type`이어야 한다. 복잡한 객체를 필드에 전달하려면 서버에서 일치하는 입력 타입을 알아야한다.

변수 정의는 옵셔널이거나 필수일 수 있다. 위의 경우 `Episode` 타입 옆에 `!`가 없으므로 옵셔널이다. 그러나 변수를 전달할 필드에 null이 아닌 인자가 요구된다면 변수가 필요하게 된다.

### 변수 기본값

타입 선언 다음에 기본값을 명시하여 쿼리에 변수에 기본값을 할당할 수도 있다.

<img width="588" alt="image" src="https://user-images.githubusercontent.com/98325285/203272104-1fb889a1-fe00-4af9-8e00-d10aa156f267.png">

모든 변수에 기본값이 제공되면 변수를 전달하지 않고도 쿼리를 호출할 수 있다. 변수가 전달되면 변수는 기본값을 덮어쓴다.

### 지시어

위에서는 동적 쿼리를 구현하기 위해 변수를 사용하여 문자열 보간 작업을 피하는 방법에 대해 알아보았다. 인자에 변수를 전달하면 이러한 문제를 상당히 해결할 수 있지만, 변수를 사용하여 쿼리의 구조와 형태를 동적으로 변경하는 방법이 필요할 수도 있다.

<img width="757" alt="image" src="https://user-images.githubusercontent.com/98325285/203272200-60d5e294-2bed-429e-8da6-682bce617f6e.png">

위 처럼 변수에 동적 값을 할당하기 위해서 지시어라는 GraphQL의 새로운 기능을 사용해야 한다. 지시어는 필드나 프래그먼트 안에 삽입될 수 있으며 서버가 원하는 방식으로 쿼리 실행에 영향을 줄 수 있다.

`@include(if: Boolean)`: 인자가 `true`인 경우에만 이 필드를 결과에 포함된다.

`@skip(if: Boolean)`: 인자가 `true`이면 이 필드를 건너뛴다.

지시어는 쿼리의 필드를 추가하고 제거하기 위해 문자열을 조작을 해야하는 상황을 피하는데 유용할 수 있다. 서버에서는 새로운 지시어를 정의하여 실험적인 기능을 추가할 수도 있다.

## 프래그먼트 안에서 변수 사용하기

쿼리나 뮤테이션에 선언된 변수는 프래그먼트에 접근할 수 있다.

<img width="688" alt="image" src="https://user-images.githubusercontent.com/98325285/202901150-1505688d-6931-4e1e-adba-1991d7c2753c.png">

## 뮤테이션

지금까지는 대부분 데이터 가져오기(fetch)에 초점을 맞췄었다. 하지만 GraphQL에는 데이터를 입력, 수정, 삭제할 수 있는 기능도 작업 타입도 있다.

기술적으로는 어떠한 쿼리든 데이터를 수정할 수 있다. 하지만 변경을 발생시키는 작업이 명시적으로 뮤테이션을 통해 전송되어야 한다는 규칙을 정하는 것이 좋다고 한다.

쿼리와 마찬가지로 뮤테이션 필드가 객체 타입을 반환하면 중첩 필드를 요청할 수 있다.

<img width="1160" alt="image" src="https://user-images.githubusercontent.com/98325285/203540585-1cb0b555-b650-4541-9b2a-b889421b186d.png">

`createReview` 필드가 새로 생성된 리뷰의 `stars`와 `commentary` 필드를 반환한다. 이는 하나의 요청으로 필드의 새 값을 변경하고 쿼리할 수 있기 때문에 기존 데이터를 변경하는 경우(예: 필드를 증가시킬 때) 특히 유용하다.

이 예제에서 전달한 `review` 변수는 스칼라값이 아니다. 인자로 전달될 수 있는 특별한 종류의 객체 타입인 *input object type*이다.

### 뮤테이션 다중 필드

뮤테이션은 쿼리와 마찬가지로 여러 필드를 포함할 수 있다. 쿼리와 뮤테이션 사이에 중요한 차이점이 있다.

**쿼리 필드는 병렬로 실행되지만 뮤테이션 필드는 하나씩 차례대로 실행된다.**

즉, 하나의 요청에서 두개의 `incrementCredits` 뮤테이션을 보내면 첫번째는 두번째 요청 전에 완료되는 것을 보장한다는 것이다.

## 인라인 프래그먼트

다른 여런 타입 시스템과 마찬가지로 GraphQL 스키마에는 인터페이스와 유니온 타입을 정의하는 기능이 포함되어 있다.

인터페이스나 유니언 타입을 반환하는 필드를 쿼리하는 경우, *인라인 프래크먼트*를 사용해아 한다.
<img width="731" alt="image" src="https://user-images.githubusercontent.com/98325285/203543261-62c76d71-a1b3-4bbb-be66-6a2162abb99f.png">
이 쿼리에서 `hero`필드는 `Character`를 반환하는데, `episode` 인자에 따라서 `Human`이나 `Droid` 중 하나일 수 있다. 필드를 직접 선택할 때에는 `name`과 같이 `Character`인터페이스에 존재하는 필드만 요청할 수 있다.

특정한 타입의 필드를 요청하려면 타입 조건과 함께 *인라인 프래그먼트*를 사용해야한다. 첫번째 프래그먼트는 `… on Droid`라는 레이블이 붙어있기 때문에 `primaryFunction`필드는 `hero`에서 반환된 `Character`가 `Droid` 타입인 경우에만 실행된다. `Human` 타입의 `height` 필드도 마찬가지이다.

## 메타 필드

GraphQL 서비스에서 리턴될 타입을 모르는 상황이 발생하면 클라이언트에서 해당 데이터를 처리하는 방법을 결정할 방법이 필요하다. GraphQL을 사용하면 쿼리의 어느 지점에서나 메타 필드인 `__typename`을 요청하여 그 시점에서 객체 타입의 이름을 얻을 수 있다.

<img width="690" alt="image" src="https://user-images.githubusercontent.com/98325285/203545297-93b6fbff-4d6f-46a6-a845-fcb44056ef0d.png">
